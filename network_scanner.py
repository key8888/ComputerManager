import socket
import threading
from queue import Queue
import time

# --- è¨­å®šé …ç›® ---

# ã‚¹ã‚­ãƒ£ãƒ³ã‚’è©¦ã¿ã‚‹ãƒãƒ¼ãƒˆã®ãƒªã‚¹ãƒˆ
# ä¸€èˆ¬çš„ãªãƒãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡ºã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
# (HTTP, HTTPS, Windows NetBIOS, SSH, SMB, RDPãªã©)
PORTS_TO_SCAN = [5000]

# åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ•°ï¼ˆå€¤ã‚’å¤§ããã™ã‚‹ã¨é«˜é€Ÿã«ãªã‚Šã¾ã™ãŒã€PCã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®è² è·ãŒä¸ŠãŒã‚Šã¾ã™ï¼‰
THREAD_COUNT = 100

# æ¥ç¶šè©¦è¡Œã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆç§’ï¼‰
CONNECTION_TIMEOUT = 1

# --- ãƒ—ãƒ­ã‚°ãƒ©ãƒ æœ¬ä½“ ---

# ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ã‚­ãƒ¥ãƒ¼
ip_queue = Queue()
# ç™ºè¦‹ã—ãŸãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
found_devices = []
# è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ãƒªã‚¹ãƒˆã¸å®‰å…¨ã«æ›¸ãè¾¼ã‚€ãŸã‚ã®ãƒ­ãƒƒã‚¯
list_lock = threading.Lock()


def get_network_prefix():
    """
    å®Ÿè¡Œä¸­PCã®ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
    ä¾‹: 192.168.1.10 -> 192.168.1.
    """
    # UDPã‚½ã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦è‡ªèº«ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # ã“ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯å®Ÿéš›ã«ãƒ‘ã‚±ãƒƒãƒˆã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“
        s.connect(('10.255.255.255', 1))
        ip = s.getsockname()[0]
    except Exception:
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã•ã‚Œã¦ã„ãªã„å ´åˆãªã©ã¯localhostã‚’è¿”ã™
        ip = '127.0.0.1'
    finally:
        s.close()

    # IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®æœ€å¾Œã®éƒ¨åˆ†ã‚’å–ã‚Šé™¤ãã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éƒ¨ã‚’è¿”ã™
    return ".".join(ip.split('.')[:-1]) + "."


def scan_ports(ip):
    """
    å˜ä¸€ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ã€å®šç¾©ã•ã‚ŒãŸãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ã€‚
    """
    for port in PORTS_TO_SCAN:
        try:
            # TCPã‚½ã‚±ãƒƒãƒˆã‚’ä½œæˆ
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
                # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                sock.settimeout(CONNECTION_TIMEOUT)
                # connect_exã¯æ¥ç¶šå¤±æ•—æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’é€å‡ºã›ãšã€æˆ»ã‚Šå€¤ã§çµæœã‚’è¿”ã™
                # æ¥ç¶šæˆåŠŸæ™‚ã¯ 0 ã‚’è¿”ã™
                if sock.connect_ex((ip, port)) == 0:
                    # ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ï¼ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹
                    with list_lock:
                        # ã¾ã ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿è¿½åŠ 
                        if ip not in found_devices:
                            print(f"âœ… ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹: {ip} (ãƒãƒ¼ãƒˆ {port} ãŒã‚ªãƒ¼ãƒ—ãƒ³)")
                            found_devices.append(ip)
                    # 1ã¤ã§ã‚‚ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Œã°ã€ãã®IPã®ã‚¹ã‚­ãƒ£ãƒ³ã¯çµ‚äº†
                    return
        except socket.error:
            # ã‚½ã‚±ãƒƒãƒˆé–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            pass


def worker():
    """
    ã‚­ãƒ¥ãƒ¼ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–ã‚Šå‡ºã—ã€ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‡¦ç†ã€‚
    """
    while not ip_queue.empty():
        ip = ip_queue.get()
        scan_ports(ip)
        ip_queue.task_done()


def get_live_devices() -> list:
    """
    ãƒ¡ã‚¤ãƒ³ã®å®Ÿè¡Œé–¢æ•°ã€‚
    """
    print("ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã™...")

    # 1. ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å–å¾—
    network_prefix = get_network_prefix()
    if network_prefix == '127.0.0.':
        print("âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
        return []

    print(f"ğŸ“¡ å¯¾è±¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: {network_prefix}0/24")
    print(f"ğŸ” ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ãƒˆ: {PORTS_TO_SCAN}")
    print("-" * 40)

    # 2. ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®å…¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ1ã€œ254ï¼‰ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    for i in range(1, 255):
        ip_queue.put(network_prefix + str(i))

    start_time = time.time()

    # 3. æŒ‡å®šã•ã‚ŒãŸæ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦å®Ÿè¡Œé–‹å§‹
    threads = []
    for _ in range(THREAD_COUNT):
        thread = threading.Thread(target=worker)
        thread.daemon = True  # ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ‚äº†æ™‚ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚‚çµ‚äº†ã•ã›ã‚‹
        thread.start()
        threads.append(thread)

    # 4. ã‚­ãƒ¥ãƒ¼ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤
    ip_queue.join()

    end_time = time.time()

    # 5. çµæœã‚’è¡¨ç¤º
    print("-" * 40)
    print("ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† âœ¨")
    print(f"æ‰€è¦æ™‚é–“: {end_time - start_time:.2f} ç§’")
    if found_devices:
        print("\nç™ºè¦‹ã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§:")
        # IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ•°å€¤ã¨ã—ã¦ã‚½ãƒ¼ãƒˆã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
        sorted_devices = sorted(
            found_devices, key=lambda ip: int(ip.split('.')[-1]))
        for device in sorted_devices:
            print(f"  - {device}")
        return sorted_devices
    else:
        print("\nã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒã‚¤ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        print("ï¼ˆæ³¨æ„: ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šã‚„ã€ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ãªã„ãŸã‚æ¤œå‡ºã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰")
        return []

